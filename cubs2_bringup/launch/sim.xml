<?xml version="1.0"?>
<launch>

    <!-- Enable/disable different planes -->
    <arg name="replay" default="true"/>  <!-- Recorded flight for comparison -->
    <arg name="viz" default="true"/>    <!-- RViz visualization -->
    <arg name="gamepad" default="false"/> <!-- Gamepad control -->
    <arg name="bag_path" default="$(find-pkg-share cubs2_data)/data/cub_stabilize_2025_11_13.mcap"/>
    <arg name="plane_urdf" default="$(find-pkg-share cubs2_description)/urdf/sportcub.urdf.xacro"/>
    
    <!-- Configuration file with all tuning parameters -->
    <arg name="config_file" default="$(find-pkg-share cubs2_bringup)/config/sportcub.yaml"/>

    <!-- Replay: recorded flight from rosbag (ghost plane for comparison) -->
    <executable
        cmd="ros2 bag play $(var bag_path)
            --topics /cub1/pose /cub1/joy_serial_status
            --exclude-topics /tf /tf_static /clock
            --loop"
        output="screen"
        if="$(var replay)"
    />


    <!-- Replay: pose to TF broadcaster -->
    <node pkg="cubs2_description" exec="pose_to_tf.py" name="replay_pose_to_tf" output="screen" if="$(var replay)">
        <param name="use_sim_time" value="false"/>
        <remap from="pose" to="/cub1/pose"/>
        <param name="frame_id" value="map"/>
        <param name="child_frame_id" value="replay"/>
    </node>

    <!-- Replay: plane visualization -->
    <node pkg="robot_state_publisher" exec="robot_state_publisher" namespace="replay" output="screen" if="$(var replay)">
        <remap from="robot_description" to="/replay/description"/>
        <param name="robot_description"
               value="$(command 'xacro $(var plane_urdf) frame_id:=replay')"/>
        <param name="use_sim_time" value="false"/>
        <param name="publish_frequency" value="50.0"/>
    </node>

    <!-- Vehicle: live simulation node -->
    <node pkg="cubs2_simulation" exec="sim.py" output="screen">
        <param name="use_sim_time" value="false"/>
        <param from="$(var config_file)"/>
    </node>

    <!-- Vehicle: plane visualization -->
    <node pkg="robot_state_publisher" exec="robot_state_publisher" namespace="vehicle" output="screen">
        <remap from="robot_description" to="/vehicle/description"/>
        <param name="robot_description"
               value="$(command 'xacro $(var plane_urdf) frame_id:=vehicle')"/>
        <param name="use_sim_time" value="false"/>
        <param name="publish_frequency" value="50.0"/>
    </node>

    <!-- Planner -->
    <node pkg="cubs2_planning" exec="planner_dubins.py"
            name="dubins_planner" output="screen">
        <param name="use_sim_time" value="false"/>
        <param from="$(var config_file)"/>
    </node>

    <!-- Reference plane visualization for planner -->
    <node pkg="robot_state_publisher" exec="robot_state_publisher" namespace="reference" output="screen">
        <remap from="robot_description" to="/reference/description"/>
        <param name="robot_description"
               value="$(command 'xacro $(var plane_urdf) frame_id:=reference')"/>
        <param name="use_sim_time" value="false"/>
        <param name="publish_frequency" value="50.0"/>
    </node>

    <!-- Optional: RViz visualization -->
    <include file="$(find-pkg-share cubs2_bringup)/launch/viz.xml" if="$(var viz)"/>

    <!-- Optional: Gamepad control -->
    <include file="$(find-pkg-share cubs2_bringup)/launch/gamepad_control.xml" if="$(var gamepad)"/>

</launch>
