name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-formatters-${{ runner.os }}
          restore-keys: apt-formatters-

      - name: Install formatters
        run: |
          sudo apt-get update
          sudo apt-get install -y black clang-format

      - name: Run format check
        run: make format-check

  test:
    name: ROS 2 Tests
    runs-on: ubuntu-latest
    container:
      image: ros:jazzy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: src/cubs2

      - name: Clone cyecca dependency
        run: |
          # Clone cyecca (workspace dependency)
          git clone https://github.com/CogniPilot/cyecca.git src/cyecca

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-ros2-${{ runner.os }}-${{ hashFiles('**/package.xml') }}
          restore-keys: |
            apt-ros2-${{ runner.os }}-

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: /root/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/package.xml') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Cache rosdep
        uses: actions/cache@v4
        with:
          path: /root/.ros/rosdep
          key: rosdep-${{ runner.os }}-${{ hashFiles('**/package.xml') }}
          restore-keys: |
            rosdep-${{ runner.os }}-

      - name: Setup package repositories
        run: |
          # Ensure all Ubuntu repositories are enabled
          apt-get update
          apt-get install -y software-properties-common ccache curl
          
          # Enable universe and multiverse repositories (needed for Python packages)
          add-apt-repository -y universe
          add-apt-repository -y multiverse
          
          # Refresh package lists
          apt-get update

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: /root/.ccache
          key: ccache-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          echo "/usr/lib/ccache" >> $GITHUB_PATH

      - name: Initialize rosdep
        run: |
          # Initialize rosdep
          rosdep init || echo "rosdep already initialized"
          rosdep update

      - name: Install project dependencies
        run: |
          # Install all system dependencies via rosdep, skipping workspace dependencies
          rosdep install --from-paths src --ignore-src -r -y
          
          # Install pytest-cov for coverage reporting
          apt-get install -y python3-pytest-cov

      - name: Cache CasADi
        id: cache-casadi
        uses: actions/cache@v4
        with:
          path: /tmp/casadi.deb
          key: casadi-3.6.3-328

      - name: Download CasADi
        if: steps.cache-casadi.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/casadi.deb https://github.com/CogniPilot/helmet/raw/main/install/resources/casadi-3.6.3-328.0d8030d49-Linux.deb

      - name: Install CasADi
        run: |
          apt-get install -y /tmp/casadi.deb

      - name: Cache colcon workspace
        uses: actions/cache@v4
        with:
          path: |
            build
            install
          key: colcon-${{ runner.os }}-${{ hashFiles('**/package.xml', '**/*.cmake', 'src/**/*.cpp', 'src/**/*.hpp', 'src/cubs2/**/*.py') }}
          restore-keys: |
            colcon-${{ runner.os }}-

      - name: Build
        run: |
          . /opt/ros/jazzy/setup.sh
          cd src/cubs2
          make build CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_COMPILER_LAUNCHER=ccache"
        env:
          CCACHE_DIR: /root/.ccache

      - name: ccache statistics
        run: ccache -s

      - name: Run ROS 2 tests and linting
        run: |
          . /opt/ros/jazzy/setup.sh
          . install/setup.sh
          colcon test --event-handlers console_direct+

      - name: Check test results
        run: |
          colcon test-result --verbose
